
---

# React Fiber и процесс обновления Virtual DOM

## Что такое React Fiber?

**React Fiber** — это новый механизм согласования (_reconciliation_) в React 16, который переосмысливает процесс рендеринга и обновления. Его основная цель — сделать рендеринг виртуального DOM инкрементным: разбивать его на небольшие «задачи», управлять приоритетами и повышать отзывчивость интерфейса даже при больших объёмах работы.

## Основные преимущества Fiber

- **Приоритеты обновлений**  
  Задачи с более высоким приоритетом (анимации, пользовательские действия) не блокируются, а могут выполняться раньше.

- **Разбиение рендера**  
  Возможность прервать и возобновить рендер для избежания «заморозки» интерфейса.

- **Concurrent Mode**  
  Fiber служит основой для Concurrent Mode, позволяя React работать асинхронно и адаптироваться под текущую загрузку.

---

## Процесс обновления Virtual DOM

React использует Virtual DOM, чтобы эффективно вносить изменения в реальный DOM. Это реализуется с помощью **Fiber**, который описывает структуру компонентов и отслеживает их изменения.

### Render Phase (Reconciliation)

- **Инициирование обновления**  
  Каждое изменение состояния (через `setState`, `useState`) попадает в очередь обновлений (Update Queue). React может объединять (batch) несколько вызовов `setState` в одном событии.

- **Создание дерева Work In Progress**  
  React обходит дерево Fiber, создавая «черновую» версию Virtual DOM (Work In Progress tree). На этом этапе вызываются рендер-функции (или методы `render` для классовых компонентов), в результате чего React получает новое представление UI.

- **Diffing**  
  React сравнивает (diff) новую версию Virtual DOM (Work In Progress) со старой. Если тип элементов (компонентов) совпадает, обновляются только изменённые атрибуты и дочерние узлы. Если тип меняется, React перестраивает ветку заново.

- **Работа с ключами (`key`)**  
  Ключи помогают сопоставить исходные и новые узлы для списков, перестановок и динамических элементов, избегая полного перестроения.

- **Сбор побочных эффектов**  
  React определяет, какие узлы в DOM нужно добавить, удалить или изменить, формируя «список эффектов» (Effect List).

- **Учет приоритетов (Fiber)**  
  Обновления имеют приоритет. React может прервать текущий рендер и вернуться к нему позже, если приходит задача с более высоким приоритетом (например, пользовательское событие).

> Важно: В фазе Render изменения в реальный DOM ещё не вносятся.

---

### Commit Phase (Reconciliation применения)

- **Применение изменений к реальному DOM**  
  React берёт список эффектов и точечно обновляет реальный DOM: меняет атрибуты, добавляет или удаляет узлы.

- **Вызовы жизненного цикла и хуков**  
  Классовые компоненты: `componentDidMount`, `componentDidUpdate`, `componentWillUnmount`.  
  Функциональные компоненты: `useEffect`, `useLayoutEffect`.

- **Batch updates (пакетные обновления)**  
  Все изменения внутри одного события объединяются, чтобы избежать множественных мелких перерисовок.

---

## Concurrent Mode и Fiber

Fiber является основой **Concurrent Mode** — режима, который позволяет React частично показывать обновлённый интерфейс, не блокируя остальную часть приложения.

### Преимущества Concurrent Mode

- Плавные анимации и переходы.
- Асинхронная обработка сложных вычислений без подвисаний интерфейса.
- Приоритетный рендер важных задач.

---

## Ключевые идеи

| Термин         | Описание                                                                                  |
| -------------- | ----------------------------------------------------------------------------------------- |
| Virtual DOM    | Хранит и обновляет «черновую» структуру UI в памяти, без тяжёлых операций с реальным DOM. |
| Diffing        | Находит отличия между старой и новой версиями Virtual DOM.                                |
| Reconciliation | Применение изменений к реальному DOM.                                                     |
| Fiber          | Управляет приоритетами, прерывает и возобновляет рендер, разбивая его на небольшие части. |

---

### Учёт производительности

Если родительский компонент рендерится, по умолчанию его дочерние компоненты тоже повторно рендерятся. Для оптимизации используйте `React.memo` (или `PureComponent` в классовых компонентах).

---

### Пример: Обновление состояния с React Fiber

```JS <code>
import React, { useState } from "react";

function Counter() {
  const [count, setCount] = useState(0);

  return (
    <div>
      <p>Счётчик: {count}</p>
      <button onClick={() => setCount(count + 1)}>Увеличить</button>
    </div>
  );
}
export default Counter;
</code>
```

При каждом нажатии кнопки React Fiber планирует обновление, разбивая работу на этапы и приоритизируя задачи, чтобы интерфейс оставался отзывчивым.

---

### Пример: Оптимизация дочерних компонентов с `React.memo`

```JS <code>
import React from "react";

const Child = React.memo(({ value }) => {
  console.log("Ререндер Child");
  return <div>{value}</div>;
});

export default function Parent() {
  const [count, setCount] = React.useState(0);

  return (
    <>
      <button onClick={() => setCount(count + 1)}>Увеличить</button>
      <Child value="Только один раз рендерится" />
    </>
  );
}
</code>
```

`React.memo` предотвращает лишние рендеры дочернего компонента, если его пропсы не изменились.

---

Если нужно, могу дополнить объяснением ключевых концепций или описанием примеров.

[Источник: React Fiber и процесс обновления Virtual DOM (hackfrontend)](https://www.hackfrontend.com/docs/react/react-fiber)[3]

[1](https://www.hackfrontend.com/docs/react/react-fiber)
[2](https://dev.to/jennypollard/chto-takoie-react-fiber-react-fiber-architecture-2cho)
[3](https://www.hackfrontend.com/docs/react/react-fiber)
[4](https://blog.openreplay.com/ru/%D0%BF%D0%BE%D0%BD%D0%B8%D0%BC%D0%B0%D0%BD%D0%B8%D0%B5-react-fiber-%D1%83%D0%BB%D1%83%D1%87%D1%88%D0%B0%D0%B5%D1%82-%D0%BF%D1%80%D0%BE%D0%B8%D0%B7%D0%B2%D0%BE%D0%B4%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D1%8C-%D1%80%D0%B5%D0%BD%D0%B4%D0%B5%D1%80%D0%B8%D0%BD%D0%B3%D0%B0/)
[5](https://habr.com/ru/articles/662549/)
[6](https://habr.com/ru/articles/343504/)
[7](https://ya.ru/neurum/c/nauka-i-obrazovanie/q/v_chem_preimuschestva_algoritma_fiber_pered_a85c6656)
[8](https://www.youtube.com/watch?v=Wfj7WyuxNds)
[9](https://geekr.vercel.app/post/444276)
[10](https://vk.com/@nuancesprog-strategii-renderinga-kotorye-dolzhen-znat-kazhdyi-react-razr)
